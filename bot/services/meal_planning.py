from openai import AsyncOpenAI
import logging
from config import OPENAI_API_KEY

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

async def get_meal_plan(calories: int, exclusions_text: str = "") -> str:
    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {
                    "role": "system",
                    "content": "Ты - эксперт по питанию. Создай недельный план питания, уложившись в 400 слов."
                },
                {
                    "role": "user",
                    "content": f"""Создай план питания на 7 дней с дневной нормой {calories} калорий. 
                    Для каждого дня укажи:
                    - Завтрак
                    - Обед
                    - Ужин
                    
                    Для каждого приема пищи укажи КБЖУ (калории, белки, жиры, углеводы).

                    Используй следующие продукты, которые я отправлю в виде CSV таблицы:
                    
                    Продукт;Вес;Б;Ж;У;калл
Гречневая каша/Овсяная каша/Рис/Спагетти из твердых сортов;60 г (сух.вид);8,2;2,4;46;245
Зефир;50 г;0;3;40;160
Сырок глазированный;1 шт.;4;13;17;205
Лаваш тонкий или хлеб;50г;5,8;1,1;27;145
Яйцо ;2 шт.;12;11;0,7;158
Авокадо 50 или орехи 15;50/15;1;10;3;106
Бедра без шкуры или говядина (можно филе 240 г), см. инструкцию;200г;40;18,2;3;320
Хлебцы или хлеб для бутерброда;50г;5,8;1,1;27;145
Сыр твердый или ветчина;50 г;13;14;0,15;174
Филе грудки куриное без кожи;100 г;22;2;0;120
Сырники 150 г (можно покупать) или творог 9% 200 г;150г/200г;30;16;16;310
Джем к сырникам или творогу;50;0;0;32;136
Молоко 2,5% или йогурт натуральный или ряженка;200 мл;5,6;5;10;104
Овсяные хлопья или гранола;65 г;9,6;4,8;49,6;288
Шоколад ;50г;6,25;25,2;24;260
Фрукт на выбор  яблоки приоритет!;150 г;0,6;0,6;15;70
Сухофрукты;25 г;0,5;;15;70
Авокадо;100 г;2;15;2;160
Рыба белая нежирная или тунец или морепродукты;200 г;38;12;;280
Белая рыба (хек, минтай) или куриная/индюшиная грудка;100 г;19;6;;135
Печенье песочное или шоколад;50 г;3;12;31;265
Ряженка;400 мл;11,2;16;16,8;272
Бананы/хурма/виноград;150 г;2;0,38;35;155
Орехи или семена льна;25 г;3;15;3,5;157
Бананы 100 г или другие фрукты 200 г;100 г / 200 г;1,5;0,25;23;100
Гречневая каша/Овсяная каша/Рис/Спагетти из твердых сортов;60 г (сух.вид);8,2;2,4;46;245
Свежий овощ;200 г;3,2;0,4;11,2;70
Фарш говяжий (для котлет) или мясо на выбор (см. в инструкцию);150 г;24;27;10;345
Сыр твердый или полутвердый;50 г;13;14;0,15;174
;;;;;
Оливковое масло (натощак или к приему);10 мл;;9;;81
Рыба красная слабосоленая ;60 г;12;6;4;112
Йогурт сладкий;Порция 120-140 г;7,8;6,7;16,1;154
Кефир 1,5% или йогурт классический к протеину;300мл.;9;4,5;12;126
Молоко (можно безлактозное);300мл.;9;4,5;12;126
Бедра без кости иди говядина (смотреть инструкцию);200г;40;26;3;390

                    Используй следующий формат:
                    
                    ПОНЕДЕЛЬНИК:
                    Завтрак (К: X, Б: X, Ж: X, У: X)
                    
                    Обед (К: X, Б: X, Ж: X, У: X)
                    
                    Ужин (К: X, Б: X, Ж: X, У: X)
                    
                    И так далее для каждого дня недели. Уложись в 400 слов. Завтрак обед и ужин в сумме по калориям должны составлять {calories} ни больше ни меньше. Отправляй без markdown"""
                }
            ],
            temperature=0.7,
            max_tokens=1500
        )
        return response.choices[0].message.content
    except Exception as e:
        logging.error(f"Error getting meal plan: {e}")
        return "Извините, не удалось сгенерировать план питания. Пожалуйста, попробуйте позже."